name: Helm Chart E2E (KinD)

on:
  pull_request:
    paths:
      - 'helm/fume/**'
      - '.github/workflows/helm-e2e.yml'

permissions:
  contents: read

jobs:
  lint:
    name: Lint chart
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Helm lint
        run: |
          helm lint ./helm/fume -f ./helm/fume/values-ci.yaml

      - name: Render manifests (sanity)
        run: |
          helm template fume ./helm/fume -f ./helm/fume/values-ci.yaml > /dev/null

  e2e:
    name: Install on KinD and verify rollout
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create KinD cluster
        uses: helm/kind-action@v1.9.0
        with:
          version: v0.23.0
          node_image: kindest/node:v1.29.4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Create namespace
        run: |
          kubectl create namespace fume

      - name: Check storage class
        run: |
          # Enable hostPath StorageClass
          kubectl get storageclass
        
      - name: Create required secrets (dummy)
        run: |
          # License secret with a dummy file key
          kubectl -n fume create secret generic fume-license \
            --from-literal=license.key.lic=dummy

          # Application secrets (minimally required keys)
          kubectl -n fume create secret generic fume-secrets \
            --from-literal=FHIR_SERVER_BASE="https://example.com/fhir"

      - name: Install chart with CI overrides
        run: |
          helm install fume ./helm/fume -n fume -f ./helm/fume/values-ci.yaml

      - name: Wait for backend rollout
        run: |
          kubectl -n fume rollout status statefulset/fume-backend --timeout=120s

      - name: Basic smoke listing
        if: always()
        run: |
          kubectl -n fume get all
          kubectl -n fume describe pod fume-backend-0
          kubectl -n fume get pvc
          kubectl -n fume describe pvc snapshots-fume-backend-0
