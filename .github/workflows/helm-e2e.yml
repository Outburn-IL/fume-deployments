name: Helm Chart E2E (KinD)

on:
  pull_request:
    paths:
      - 'helm/fume/**'
      - '.github/workflows/helm-e2e.yml'

permissions:
  contents: read

jobs:
  lint:
    name: Lint chart
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4
      - name: Helm lint (base values)
        run: |
          helm lint ./helm/fume \
            --set configMap.CANONICAL_BASE_URL="https://lint.example.local" \
            --set configMap.FUME_SERVER_URL="https://api.lint.example.local" \
            --set configMap.FHIR_PACKAGES="hl7.fhir.r4.core@4.0.1"
      - name: Helm lint (prod overrides)
        run: |
          helm lint ./helm/fume -f ./helm/fume/values.prod.yaml \
            --set configMap.CANONICAL_BASE_URL="https://lint.prod.example.local" \
            --set configMap.FUME_SERVER_URL="https://api.lint.prod.example.local" \
            --set configMap.FHIR_PACKAGES="hl7.fhir.r4.core@4.0.1"
      - name: Negative schema lint (expect failure on unknown key)
        run: |
          set -euo pipefail
          if helm lint ./helm/fume \
            --set configMap.CANONICAL_BASE_URL="https://lint.neg.example.local" \
            --set configMap.FUME_SERVER_URL="https://api.lint.neg.example.local" \
            --set configMap.FHIR_PACKAGES="hl7.fhir.r4.core@4.0.1" \
            --set storage.fhircache.enabled=true >/tmp/lint-out.txt 2>&1; then
            echo "::error::Expected helm lint to fail on unknown key storage.fhircache"; cat /tmp/lint-out.txt; exit 1; fi
          echo "Negative lint test passed (unknown key storage.fhircache rejected)."
          grep -qi 'fhircache' /tmp/lint-out.txt || echo "Note: lint output did not include token 'fhircache'";

  e2e-matrix:
    name: Scenario validation
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        scenario: [default, prod]
    env:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      FUME_LICENSE_B64: ${{ secrets.FUME_LICENSE_B64 }}
      FRONTEND_ASSERT_TOKEN: "FUME Designer"  # Placeholder; adjust if needed
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Create KinD cluster
        uses: helm/kind-action@v1.9.0
        with:
          version: v0.23.0
          node_image: kindest/node:v1.29.4
      - name: Create namespace
        run: kubectl create ns fume
      - name: Create application secrets (fume-secrets)
        run: |
          # Secret required by chart; validation ensures .Values.secrets.fume exists.
          # Provide dummy FHIR server values since SERVER_STATELESS=true in CI.
          kubectl -n fume create secret generic fume-secrets \
            --from-literal=FHIR_SERVER_BASE="https://dummy.fhir.server/fhir" \
            --from-literal=FHIR_SERVER_UN="dummy-user" \
            --from-literal=FHIR_SERVER_PW="dummy-pass" || true
      - name: Create DockerHub pull secret
        run: |
          kubectl -n fume create secret docker-registry regcred \
            --docker-username=outburnltd \
            --docker-password="${DOCKERHUB_TOKEN}" \
            --docker-server="https://index.docker.io/v1/" || true
      - name: Create license secret from base64
        run: |
          printf "%s" "$FUME_LICENSE_B64" | base64 -d > license.key.lic
          kubectl -n fume create secret generic fume-license --from-file=license.key.lic
      - name: Setup kubectl (client)
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.4
      - name: Detect storage class
        run: |
          set -euo pipefail
          DEFAULT=$(kubectl get storageclass -o json | jq -r '.items[] | select(.metadata.annotations["storageclass.kubernetes.io/is-default-class"]=="true") | .metadata.name' | head -n1)
          if [ -z "$DEFAULT" ]; then
            for sc in standard local-path; do
              if kubectl get storageclass "$sc" &>/dev/null; then DEFAULT=$sc; break; fi
            done
          fi
          if [ -z "$DEFAULT" ]; then echo "::error::No usable storage class found"; exit 1; fi
          echo "STORAGE_CLASS=$DEFAULT" >> $GITHUB_ENV
      - name: Install chart (scenario)
        run: |
          set -euo pipefail
          COMMON_OVERRIDES="--set image.pullSecret=regcred --set-string env.SERVER_STATELESS=true --set storage.fhirCache.enabled=true --set configMap.FHIR_PACKAGES=hl7.fhir.r4.core@4.0.1 \
            --set storage.snapshots.storageClass=$STORAGE_CLASS --set storage.templates.storageClass=$STORAGE_CLASS --set storage.fhirCache.storageClass=$STORAGE_CLASS"
          if [ "${{ matrix.scenario }}" = "default" ]; then
            helm install fume ./helm/fume -n fume \
              $COMMON_OVERRIDES \
              --set configMap.CANONICAL_BASE_URL="https://fume.example.com" \
              --set configMap.FUME_SERVER_URL="https://api.example.com";
          else
            helm install fume ./helm/fume -n fume -f ./helm/fume/values.prod.yaml \
              $COMMON_OVERRIDES \
              --set configMap.CANONICAL_BASE_URL="https://fume.prod.example.com" \
              --set configMap.FUME_SERVER_URL="https://api.prod.example.com";
          fi
      - name: Post-install quick diagnostics
        run: |
          kubectl -n fume get pvc || true
          echo '--- Backend pod(s) status:'
          kubectl -n fume get pods -l app.kubernetes.io/component=backend -o wide || true
          echo '--- Recent events:'
          kubectl -n fume get events --sort-by=.metadata.creationTimestamp | tail -n 40 || true
      - name: Wait for backend rollout
        run: |
          kubectl -n fume rollout status statefulset/fume-backend --timeout=600s
      - name: Create curl prober pod
        run: |
          # Lightweight pod with curl for application probing; reused for version polling.
          if ! kubectl -n fume get pod curl-prober >/dev/null 2>&1; then
            kubectl -n fume run curl-prober --image=curlimages/curl:8.4.0 --restart=Never --command -- sleep 900 || true
          fi
          # Wait for prober to be Running
          for i in $(seq 1 30); do
            PHASE=$(kubectl -n fume get pod curl-prober -o jsonpath='{.status.phase}' 2>/dev/null || echo "NA")
            if [ "$PHASE" = "Running" ]; then
              echo "curl-prober pod Running (attempt $i)"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "::error::curl-prober pod did not reach Running (phase=$PHASE)";
              kubectl -n fume describe pod curl-prober || true
              kubectl -n fume logs curl-prober || true
              exit 1
            fi
            sleep 2
          done
      - name: Backend version check
        run: |
          set -euo pipefail
          APP_VERSION=$(grep '^appVersion:' helm/fume/Chart.yaml | awk '{print $2}' | tr -d '"')
          EXPECTED="fume-enterprise ${APP_VERSION}"
          TARGET_URL="http://fume-backend.fume.svc.cluster.local:42420/"
          for i in $(seq 1 48); do
            RAW=$(kubectl -n fume exec curl-prober -- curl -sS -m 3 --connect-timeout 2 -w "HTTPSTATUS:%{http_code}" "$TARGET_URL" || true)
            BODY="${RAW%HTTPSTATUS:*}"; STATUS="${RAW##*HTTPSTATUS:}"
            if [ "$STATUS" = "200" ]; then
              if echo "$BODY" | jq -e '.fume_version' >/dev/null 2>&1; then
                VER=$(echo "$BODY" | jq -r '.fume_version'); echo "Got version $VER";
                [ "$VER" = "$EXPECTED" ] || { echo "::error::Version mismatch expected $EXPECTED got $VER"; exit 1; }
                printf "%s" "$BODY" > /tmp/root-endpoint.json
                break
              else
                echo "200 OK but missing fume_version key (attempt $i)"
              fi
            else
              echo "Attempt $i: status=$STATUS (waiting)"
            fi
            [ $i -eq 48 ] && echo "::error::Timeout waiting for version JSON" && exit 1
            sleep 5
          done
      - name: Frontend HTML smoke test (default only)
        if: matrix.scenario == 'default'
        run: |
          set -euo pipefail
          TARGET_URL="http://fume-frontend.fume.svc.cluster.local:3000/"
          SUCCESS=0
          for i in $(seq 1 15); do
            RAW=$(kubectl -n fume exec curl-prober -- curl -sS -m 5 --connect-timeout 3 -w "HTTPSTATUS:%{http_code}" "$TARGET_URL" || true)
            BODY="${RAW%HTTPSTATUS:*}"; STATUS="${RAW##*HTTPSTATUS:}"
            if [ "$STATUS" = "200" ]; then
              echo "Attempt $i: 200 OK"
              if echo "$BODY" | grep -qi "${FRONTEND_ASSERT_TOKEN}"; then
                echo "$BODY" | head -n 40 > /tmp/frontend-sample.html
                echo "Frontend HTML contains token '${FRONTEND_ASSERT_TOKEN}'"
                SUCCESS=1
                break
              else
                echo "Attempt $i: token '${FRONTEND_ASSERT_TOKEN}' not found yet"
              fi
            else
              echo "Attempt $i: status=$STATUS (waiting)"
            fi
            [ $i -eq 15 ] && echo "::error::Frontend root did not become ready / token missing" && exit 1
            sleep 4
          done
          [ $SUCCESS -eq 1 ] || { echo "::error::Frontend HTML validation failed"; exit 1; }
      - name: Check fhirCache folder population
        run: |
          set -euo pipefail
          TARGET_DIR='hl7.fhir.r4.core#4.0.1'
          for i in $(seq 1 20); do
            if kubectl -n fume exec fume-backend-0 -- sh -c "ls -1 /usr/fume/fhir-packages | grep -F '$TARGET_DIR'" >/dev/null 2>&1; then
              echo "Found expected FHIR package directory: $TARGET_DIR";
              kubectl -n fume exec fume-backend-0 -- sh -c "ls -1 /usr/fume/fhir-packages" > /tmp/fhir-cache-list.txt
              exit 0;
            fi
            [ $i -eq 20 ] && echo "::error::Did not find $TARGET_DIR in fhir-cache" && exit 1
            sleep 15
          done
      - name: Diagnostics on failure
        if: failure()
        run: |
          set -euo pipefail
          mkdir -p /tmp/diagnostics
          kubectl -n fume describe statefulset fume-backend > /tmp/diagnostics/statefulset.txt || true
          kubectl -n fume describe pod fume-backend-0 > /tmp/diagnostics/pod.txt || true
          kubectl -n fume logs statefulset/fume-backend --tail=400 > /tmp/diagnostics/pod-logs.txt || true
          kubectl -n fume exec fume-backend-0 -- sh -c 'for f in /usr/fume/logs/*.log; do echo "==== $f (tail 200) ===="; tail -n 200 "$f"; done' > /tmp/diagnostics/app-logs.txt || true
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fume-e2e-artifacts-${{ matrix.scenario }}
          path: |
            /tmp/root-endpoint.json
            /tmp/fhir-cache-list.txt
            /tmp/frontend-sample.html
            /tmp/diagnostics
      - name: Cleanup namespace
        if: always()
        run: |
          kubectl delete ns fume --wait=false || true
